{% extends "world/world_list.html" if not world_theme else world_theme %}

{% if world %}
    {% set recent_articles=world.articles().order_by('-created_date')[:5] if world %}
    {% set focus_articles=world.articles().order_by('-created_date').filter(featured=true)[:5] %}
    {% set top_material=world.articles().order_by('-created_date').filter(type='material')[:5] %}
{% endif %}

{% block content_title %}{{ world.title if world else publisher.title}}{% endblock %}
{% block content_tagline %}{% endblock %}


{% block hero_box %}{# Hide the hero if we are editing, it's destracting #}
    {% if not world_form %}{{ super() }}{% endif %}
{% endblock hero_box %}

{% block cssimports %}
    {{ super() }}
    {% if world %}
        <link rel="home" type="application/rss+xml"
              href="{{ url_for('world.ArticlesView:feed', publisher_=publisher.slug, world_=world.slug, _external=true, _scheme='') }}"/>
    {% endif %}
{% endblock %}


{% block sidebar %}
    {% if world and world.get_feature_image %}
        <a class="zoomable" href="{{ url_for('image', slug = world.get_feature_image.slug) }}"><img class="img-responsive"
                                                                                                src="{{ url_for('image', slug = world.get_feature_image.slug) }}"></a>
    {% endif %}
    <div>
        <ul class="nav nav-pills nav-stacked">
            <li><a href="{{ url_for('world.WorldsView:get', publisher_=publisher.slug, id=world.slug) }}"><span
                    class="glyphicon glyphicon-home"></span> {{ _('Home') }}</a></li>
            {% if world %}
                <li>
                    <a href="{{ url_for('world.ArticlesView:index', publisher_=publisher.slug, world_=world.slug) }}"><span
                            class="glyphicon glyphicon-filter"></span> {{ _('Browse') }}</a></li>
                <li>
                    <a href="{{ url_for('world.ArticlesView:blog', publisher_=publisher.slug, world_=world.slug) }}"><span
                            class="glyphicon glyphicon-asterisk"></span> {{ _('Blog') }}</a></li>
                <li>
                    <a href="{{ url_for('world.ArticlesView:random', publisher_=publisher.slug, world_=world.slug) }}"><span
                            class="glyphicon glyphicon-flash"></span> {{ _('Random article') }}</a></li>
                {% include "world/new_article_menu.html" %}
                {% if world.slug != 'meta' and not article %} {# only show if we have only a world #}
                    {% call(privileged) MACRO.AUTHORIZED(access_policy['world'].authorize('edit', instance=world)) %}
                        <li><a class="{{ privileged }}"
                               href="{{ url_for('world.WorldsView:get', publisher_=publisher.slug, intent='patch', id=world.slug) }}"><span
                                class="glyphicon glyphicon-edit"></span> {{ _('Edit') }} {{ _('world') }}</a></li>
                    {% endcall %}
                {% endif %}

            {% endif %}
        </ul>
    </div>
{% endblock %}

{% block sidebar_end %}
    {% include 'includes/social_icons.html' %}
{% endblock %}

{% block content %}
    {% if world_form %}
        <form method="post" action="{{ action_url }}">
            <div class="row">
                <div class="col-md-8">
                    {{ MACRO.FORM_FIELD(world_form.title) }}
                    {{ MACRO.FORM_FIELD(world_form.description, controlclass=' content-editor') }}
                    {{ MACRO.FORM_FIELD(world_form.publisher) }}
                    {{ MACRO.FORM_FIELD(world_form.rule_system) }}
                    {{ MACRO.FORM_FIELD(world_form.status) }}
                    {{ MACRO.FORM_FIELD(world_form.languages, controlclass='selectize') }}
                    {{ MACRO.FORM_FIELD(world_form.editors, controlclass='selectize') }}
                    {{ MACRO.FORM_FIELD(world_form.readers, controlclass='selectize') }}
                    {{ world_form.csrf_token }}
                </div>
                <div class="col-md-4">
                    {# data_end becomes data-end automatically #}
                    {{ MACRO.FORM_FIELD(world_form.images, controlclass="fileselect", data_endpoint=
                        url_for('assets.FileAssetsView:file_selector', type='image', choice='multiple'), data_class='image') }}
                </div>
            </div>
            <div class="row form-actions">
                <button type="submit" class="btn btn-primary">{{ _('Save changes') }}</button>
                <a href="{{ url_for('world.WorldsView:index', publisher_=publisher.slug) }}"
                   class="btn btn-default">{{ _('Cancel') }}</a>
                {% if world %}
                    <a href="{{ url_for('world.WorldsView:delete', publisher_=publisher.slug, id=world.slug, method='DELETE') }}"
                       class="btn btn-danger pull-right">{{ _('Delete') }}</a>
                {% endif %}
            </div>
        </form>
    {% else %}
        <div class="row">
            <div class="col-md-6">
                <p class="worldDesc">{{ world.description|markdown }}</p>
            </div>
            <div class="col-md-4">
                <p class="text-center"><a class="btn btn-lg btn-info" href="{{ url_for('shop.ProductsView:index', publisher=publisher.slug, world=world.slug) }}">
                    {% trans %}Buy in shop{% endtrans %}</a></p>
                <table class="table">
                    <tr>
                        <td><strong>{{ _('Publisher') }}</strong></td>
                        <td>
                            <small>{{ world.publisher|default(_('No data'), true) }}</small>
                        </td>
                    </tr>
                    <tr>
                        <td><strong>{{ _('Rule System') }}</strong></td>
                        <td>
                            <small>{{ world.rule_system|default(_('No data'), true) }}</small>
                        </td>
                    </tr>
                    {#
        <tr><td><strong>{{ _('Status') }}</strong></td>
        <td><small>{{ world.get_status_display()|default(_('No data'), true) }}</small></td></tr>
#}

                </table>
            </div>
            <!--<div class="col-md-5 imgAside pull-right">{{ _('IMAGE') }}-->
            <!--</div>-->
        </div>
        <div class="row">
            <div class="col-md-4">
                <h4><span class="glyphicon glyphicon-exclamation-sign"></span> {% trans %}Recent updates{% endtrans %}
                </h4>
                <ul>
                    {% for a in recent_articles %}
                        <li>
                            <a href="{{ url_for('world.ArticlesView:get', publisher_=publisher.slug, id=a.slug, world_=world.slug) }}"
                               alt="{{ a.title }}">{{ a.title }}</a></li>
                    {% else %}
                        {% trans %}No data{% endtrans %}
                    {% endfor %}
                </ul>
            </div>
            <div class="col-md-4">
                {% if focus_articles %}
                    <h4><span class="glyphicon glyphicon-star"></span> {% trans %}Featured articles{% endtrans %}</h4>
                    {% for a in focus_articles %}
                        <li>
                            <a href="{{ url_for('world.ArticlesView:get', publisher_=publisher.slug, id=a.slug, world_=world.slug) }}"
                               alt="{{ a.title }}">{{ a.title }}</a></li>
                    {% endfor %}
                {% endif %}
            </div>
            <div class="col-md-4">
                {% if top_material %}
                    <h4><span class="glyphicon glyphicon-briefcase"></span> {% trans %}Top material{% endtrans %}</h4>
                    {% for a in top_material %}
                        <li>
                            <a href="{{ url_for('world.ArticlesView:get', publisher_=publisher.slug, id=a.slug, world_=world.slug) }}"
                               alt="{{ a.title }}">{{ a.title }}</a></li>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    {% endif %}
{% endblock content %}