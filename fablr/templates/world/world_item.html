{% extends "world/_page.html" if not parent_template else parent_template %}
{% import 'includes/macros.html' as MACRO %}

{% block cssimports %}
{{ super() }}
{% if world %}
<link rel="home" type="application/rss+xml" href="{{url_for('.article_feed', world=world.slug, _external=true)}}" />
{% endif %}
{% endblock %}

{% block content_title %}{{ world.title }}{{ ' - ' + article.title if article else '' }}{% endblock %}
{% block content_tagline %}{% endblock %}



{% block sidebar %}
{% if world.feature_image %}<a class="lightbox" href="{{url_for('image', slug = world.feature_image.slug)}}"><img class="img-responsive" src="{{url_for('image', slug = world.feature_image.slug)}}"></a>
{% else %}
  <span class="glyphicon glyphicon-globe gianticon"></span>
{% endif %}

<div class="">
  <ul class="nav nav-pills nav-stacked">
      <li><a href="/"><span class="glyphicon glyphicon-home"></span> {{ _('Home') }}</a></li>
      {% if world %}
      <li><a href="{{ url_for('world.article_list', world=world.slug) }}"><span class="glyphicon glyphicon-filter"></span> {{ _('Browse') }}</a></li>
      <li><a href="{{ url_for('world.article_blog', world=world.slug) }}"><span class="glyphicon glyphicon-asterisk"></span> {{ _('Blog') }}</a></li>
    {% call(privileged) MACRO.AUTHORIZED(access_policy['article'].authorize('new')) %}
      <li class="dropdown">
        <a class="dropdown-toggle {{privileged}}" data-toggle="dropdown" href="#"><span class="glyphicon glyphicon-pencil"></span> {{ _('New article') }}&nbsp;<span class="caret"></span>
        </a>
        <ul class="dropdown-menu">
          <li><a href="{{url_for('world.article_form_new', world=world.slug, type='default')}}"><span class="glyphicon glyphicon-record"></span> {{ _('Default') }}</a></li>
          <li><a href="{{url_for('world.article_form_new', world=world.slug, type='blogpost')}}"><span class="glyphicon glyphicon-asterisk"></span> {{ _('Blog post') }}</a></li>
          <li><a href="{{url_for('world.article_form_new', world=world.slug, type='material')}}"><span class="glyphicon glyphicon-briefcase"></span> {{ _('Material') }}</a></li>
          <li><a href="{{url_for('world.article_form_new', world=world.slug, type='person')}}"><span class="glyphicon glyphicon-eye-open"></span> {{ _('Person') }}</a></li>
          <li><a href="{{url_for('world.article_form_new', world=world.slug, type='fraction')}}"><span class="glyphicon glyphicon-certificate"></span> {{ _('Fraction') }}</a></li>
          <li><a href="{{url_for('world.article_form_new', world=world.slug, type='place')}}"><span class="glyphicon glyphicon-map-marker"></span> {{ _('Place') }}</a></li>
          <li><a href="{{url_for('world.article_form_new', world=world.slug, type='event')}}"><span class="glyphicon glyphicon-exclamation-sign"></span> {{ _('Event') }}</a></li>
          <li><a href="{{url_for('world.article_form_new', world=world.slug, type='campaign')}}"><span class="glyphicon glyphicon-flag"></span> {{ _('Campaign') }}</a></li>
          <li><a href="{{url_for('world.article_form_new', world=world.slug, type='chronicle')}}"><span class="glyphicon glyphicon-bookmark"></span> {{ _('Chronicle') }}</a></li>
        </ul>
      </li>
    {% endcall %}
    {% call(privileged) MACRO.AUTHORIZED(access_policy['world'].authorize('edit')) %}
    <li><a class="{{privileged}}" href="{{ url_for('world.world_form_edit', world=world.slug) }}"><span class="glyphicon glyphicon-edit"></span> {{ _('Edit') }}</a></li>
    {% endcall %}
    {% endif %}
</ul>
</div>
{% endblock %}

{% block content %}
{% if world_form %}
<form method="post" action="{{world_form.action_url}}">
  <div class="row">
    <div class="col-md-8">
      {{ MACRO.FORM_FIELD(world_form.title) }}
      {{ MACRO.FORM_FIELD(world_form.description) }}
      {{ MACRO.FORM_FIELD(world_form.publisher) }}
      {{ MACRO.FORM_FIELD(world_form.rule_system) }}
      {{ MACRO.FORM_FIELD(world_form.status) }}
      {{ world_form.csrf_token }}
    </div>
    <div class="col-md-4">
      {{ MACRO.FORM_FIELD(world_form.feature_image, **{'data-imageselect':true})}}
    </div>
  </div>
  <div class="row form-actions">
    <button type="submit" class="btn btn-primary">{{ _('Save changes') }}</button>
    <a href="{{url_for('.world_list')}}" class="btn btn-default">{{ _('Cancel') }}</a>
    {% if world %}
      <a href="{{url_for('.world_delete', world=world.slug)}}" class="btn btn-danger pull-right">{{ _('Delete') }}</a>
    {% endif %}
  </div>
</form>
{% else %}
  <div class="row">
    <div class="col-md-6">
      <p class="worldDesc">{{ world.description }}</p>
    </div>
    <div class="col-md-4">
      <table class="table">
        <tr><td><strong>{{ _('Publisher') }}</strong></td>
        <td><small>{{ world.publisher|default(_('No data'), true) }}</small></td></tr>
        <tr><td><strong>{{ _('Rule System') }}</strong></td>
        <td><small>{{ world.rule_system|default(_('No data'), true) }}</small></td></tr>
        <tr><td><strong>{{ _('Status') }}</strong></td>
        <td>{{ world.status|default(_('No data'), true) }}</td></tr>

      </table>
    </div>
    <!--<div class="col-md-5 imgAside pull-right">{{ _('IMAGE') }}-->
    <!--</div>-->
  </div>
  <div class="row">
    <div class="col-md-4">
      <h4>{% trans %}Recent updates{% endtrans %}</h4>
    </div>
    <div class="col-md-4">
      <h4>{% trans %}Featured articles{% endtrans %}</h4>
    </div>
    <div class="col-md-4">
      <h4>{% trans %}Top material{% endtrans %}</h4>
    </div>
  </div>
  <div class="row worldArticles">
    <hr>
    <h3>{% trans %}All articles{% endtrans %}</h3>
    {% set articles = world.articles() %}
    {% if articles %}
    {{ MACRO.LIST_CONTROLS(articles[0].__class__, ['title', 'creator', 'type', 'created']) }}

    {% if request.args.get('view', 'table') == 'table' %}

    <table class="table table-hover">
    {{ MACRO.TABLE_HEADER(articles[0].__class__, ['title', 'creator', 'type', 'created']) }}
    <tbody>
    	{% for article in articles %}
    	<tr>
    		<td><a href="{{ url_for('.article_form_edit',  world=world.slug, article=article.slug)}}">{{article.title}}</a></td>
    		<td>{{article.creator}}</td>
    		<td>{{article.type}}</td>
        <td class="small">{{article.created_date.strftime('%Y-%m-%d %H:%M')}}</td>
    	</tr>
    	{% endfor %}
    </tbody>
    </table>
    {% else %}
    <div class="cards">
    <div class="row">
    {% for article in articles %}
    <div class="col-md-4 product"
    {%- if article.feature_image %}style="background: rgba(255,255,255,0.7); background-position: center;
  background-repeat: no-repeat; background-image: url({{url_for('image_thumb', slug=article.feature_image.slug)}})"
    {%- endif -%}>
        <div class="product-intro">
            <h3><a href="{{ url_for('.article_form_edit', world=world.slug, article=article.slug)}}">{{article}}</a></h3>
        </div>
        <ul class="product-details">
            <li class="product-type">{{article.creator}}</li>
            <li class="product-type">{{article.created_date.strftime('%Y-%m-%d %H:%M')}}</li>
        </ul>
    </div>
    {% if loop.index is divisibleby 3 %}</div><div class="row">{% endif %}
    {% endfor %}
    </div></div>
    {% endif %}
    {% include "includes/pagination.html" %}
    {% endif %}
  </div>
{% endif %}
{% endblock %}

{% block final %}
{{super()}}
<script>
var imageselect_options = {
    csrf_token: "{{ csrf_token() }}",
    image_list_url: "{{url_for('assets.imageasset_list', per_page='all', out='modal')}}",
    image_upload_url: "{{url_for('assets.imageasset_new', out='json')}}"
  }
</script>
{% endblock %}