{% extends "shop/product_list.html" if not parent_template else parent_template %}
{% import 'includes/macros.html' as MACRO %}

{% set product_icons = {'book':'book','item':'glass','digital':'floppy-disk','shipping':'barcode'}%}

{% set currencies = {
  'eur' : 'â‚¬ %s',
  'sek' : '%s :-'
}%}

{% block content_title %}{{product.title if product else _("New product")}}{% endblock %}
{% block content_tagline %}{% endblock %}

{% block sidebar %}{{super()}}

{% if product %}
{% call(privileged) MACRO.AUTHORIZED(access_policy['product'].authorize('edit')) %}
<ul class="nav nav-pills nav-stacked">
  <li class="{{privileged}}"><a href="{{ url_for('.product_form_edit', product=product.slug) }}"><span class="glyphicon glyphicon-edit"></span> {{ _('Edit') }}</a></li>
</ul>
{% endcall %}
{% endif %}
{%endblock%}

{% block content %}{% block inline %}
{% if product_form %}
<img id="testimage">
<form method="post" action="{{product_form.action_url}}">
  <div class="row">
    <div class="col-md-8">
      {{ MACRO.FORM_FIELD(product_form.title) }}
      {{ MACRO.FORM_FIELD(product_form.description) }}
      {{ MACRO.FORM_FIELD(product_form.publisher) }}
      {{ MACRO.FORM_FIELD(product_form.family) }}
      {{ MACRO.FORM_FIELD(product_form.created) }}
      {{ MACRO.FORM_FIELD(product_form.type) }}
      {{ MACRO.FORM_FIELD(product_form.price, required=true) }}
      {{ MACRO.FORM_FIELD(product_form.currency, required=true) }}
      {{ MACRO.FORM_FIELD(product_form.status) }}
      {{ MACRO.FORM_FIELD(product_form.acknowledgement) }}
      {{ product_form.csrf_token }}
    </div>
    <div class="col-md-4">
      {{ MACRO.FORM_FIELD(product_form.feature_image, **{'data-imageselect':true})}}
      {{ MACRO.FORM_FIELD(product_form.downloadable_files) }}
    </div>
  </div>
  <div class="row form-actions">
    <button type="submit" class="btn btn-primary">{{ _('Save changes') }}</button>
    <a href="{{url_for('.product_list')}}" class="btn btn-default">{{ _('Cancel') }}</a>
    {% if product %}
      <a href="{{url_for('.product_delete', product=product.slug)}}" class="btn btn-danger pull-right">{{ _('Delete') }}</a>
    {% endif %}
  </div>
</form>
{% else %}
<div class="row">
    <div class="col-md-8">
      <table class="table">
        <tr><td><strong>{{ _('Title') }}</strong></td>
        <td><small>{{ product.title }}</small></td></tr>
        <tr><td><strong>{{ _('Publisher') }}</strong></td>
        <td><small>{{ product.publisher }}</small></td></tr>
        <tr><td><strong>{{ _('Family') }}</strong></td>
        <td>{{ product.family }}</td></tr>
        <tr><td><strong>{{ _('Created') }}</strong></td>
        <td>{{ product.created.strftime('%Y-%m-%d %H:%M') }}</td></tr>
        <tr><td><strong>{{ _('Type') }}</strong></td>
        <td><small>{{ product.get_type_display() }}</small></td></tr>
        <tr><td><strong>{{ _('Price') }}</strong></td>
        <td><small>{{ currencies[product.currency] % product.price|currency }}</small></td></tr>
        <tr><td><strong>{{ _('Currency') }}</strong></td>
        <td><small>{{ product.get_currency_display() }}</small></td></tr>
        <tr><td><strong>{{ _('Status') }}</strong></td>
        <td><small>{{ product.get_status_display() }}</small></td></tr>

      </table>

      <div class="well">{{ product.description }}</div>
      {% if product.downloadable_files %}
      <div class="well"><strong>{{ _('Downloadable files') }}</strong>
          {% for file_asset in product.downloadable_files %}
          <div>{% if product.is_owned_by_current_user() %}<a
                  href="{{ url_for('download', fileasset=file_asset.slug) }}"><span
                  class="glyphicon glyphicon-download"></span> <strong>{{ file_asset.title }}</strong></a>{% else %}
              <strong>{{ file_asset.title }}</strong>{% endif %}{% if file_asset.description
              %}: {{ file_asset.description }}{% endif %}</div>
          {% endfor %}
      </div>
      {% endif %}
    </div>
    <div class="col-md-4">
      {% if product.feature_image %}<a class="lightbox" href="{{url_for('image', slug = product.feature_image.slug)}}"><img class="img-responsive" src="{{url_for('image', slug = product.feature_image.slug)}}"></a>
      {% else %}
        <span class="glyphicon glyphicon-{{product_icons[product.type]}} gianticon"></span>
      {% endif %}
      <!--<a id="{{product.slug}}" class="btn btn-buy btn-primary buy-link" href="{{ url_for('.order_cart')}}">{{ _('Buy') }}</a>-->
    </div>
</div>
{% endif %}
{% endblock %}{% endblock %}

{% block final %}
{{super()}}
<script>
var imageselect_options = {
    csrf_token: "{{ csrf_token() }}",
    image_list_url: "{{url_for('assets.imageasset_list', per_page='all', out='modal')}}",
    image_upload_url: "{{url_for('assets.imageasset_new', out='json')}}"
  }

$('.buy-link').click(function(e) {
    $.ajax({
        url: "{{ url_for('.order_cart', out='json')}}",
        type: 'post',
        data: {product: this.id},
        headers: { 'X-CSRFToken': "{{ csrf_token() }}" },
        dataType: 'json',
        success: function (data) {
            $c = $('#cart-counter')
            $c.addClass("bounce").one('animationend webkitAnimationEnd oAnimationEnd', function() {
              $c.removeClass("bounce");
              $c.find('.badge').html(data.item)
            });
        },
        error: function (jqXHR, textStatus, errorThrown) {
            flash_error(errorThrown)
        }
    });
    e.preventDefault();
});
</script>
{% endblock %}
