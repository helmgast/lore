{% extends "shop/_page.html" %}

{% set currencies = {
  'eur' : 'â‚¬ %s',
  'sek' : '%s :-'
} %}

{% block sidebar %}{{ super() }}
    {% if not product %}
        {% call(privileged) MACRO.AUTHORIZED(access_policy['product'].authorize('new')) %}
            <ul class="nav nav-pills nav-stacked">
                <li><a class="{{ privileged }}"
                       href="{{ url_for('shop.ProductsView:get', publisher=publisher.slug, id='post') }}"><span
                        class="glyphicon glyphicon-plus-sign"></span> {{ _('New product') }}</a></li>
            </ul>
        {% endcall %}
    {% endif %}
{% endblock %}

{% block content %}
    {{ MACRO.LIST_CONTROLS(model, ['title', 'description', 'type', 'world', 'price'], set_view=args['view'], default='card') }}

    {% if args['view'] == 'list' %}

        {% for product in products %}
            <a class="blog_header"
               href="{{ url_for('shop.ProductsView:get', publisher=publisher.slug, id=product.slug) }}">
                <h3>{{ product.title }}</h3></a>
            <ul class="list-inline article-meta" style="margin-bottom: 0">
                <li title="{{ _('Created') }}"><span
                        class="glyphicon glyphicon-calendar"></span> {{ product.created.strftime('%Y-%m-%d') }}</li>
            </ul>
            <div class="media">
                {% if product.feature_image %}
                    <a class="pull-left"
                       href="{{ url_for('shop.ProductsView:get', publisher=publisher.slug, id=product.slug) }}">
                        <img class="media-object" src="{{ url_for('image_thumb', slug=product.feature_image.slug) }}">
                    </a>
                {% endif %}
                <div class="media-body">
                    {{ product.description }}
                    <a href="{{ url_for('shop.ProductsView:get', publisher=publisher.slug, id=product.slug) }}"><em
                            style="white-space: nowrap;">{{ _('Read more') }}</em></a>
                </div>
            </div>
        {% endfor %}

    {% elif args['view'] == 'table' %}

        <table class="table table-hover">
            {{ MACRO.TABLE_HEADER(model, ['title', 'description', 'type', 'world', 'price']) }}
            <tbody>
            {% for product in products %}
                <tr>
                    <td>
                        <a href="{{ url_for('shop.ProductsView:get', publisher=publisher.slug, id=product.slug) }}">{{ product.title }}</a>
                    </td>
                    <td>{{ product.description }}</td>
                    <td>{{ product.get_field_display('type') }}</td>
                    <td>{{ product.world|default(_('No data'),true) }}</td>
                    <td class="product-price">{{ currencies[product.currency] % product.price|currency }}</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>

    {% else %} {# ==table #}
        <div class="cards">
        <div class="row">
        {% for product in products %}
            <div class="col-md-4 product">
                {% if product.feature_image %}
                    <a href="{{ url_for('shop.ProductsView:get', publisher=publisher.slug, id=product.slug) }}"><img
                            class="product-image"
                            src="{{ url_for('image_thumb', slug=product.feature_image.slug) }}"></a>{% endif %}
                <div class="product-intro">
                    <h3>
                        <a href="{{ url_for('shop.ProductsView:get', publisher=publisher.slug, id=product.slug) }}">{{ product.title }}</a>
                    </h3>
                    <p>{{ product.description }}</p>
                </div>
                <ul class="product-details">
                    <li class="product-type">{{ product.publisher }}</li>
                    <li class="product-price">{{ currencies[product.currency] % product.price|currency }}</li>
                    <li><a id="{{ product.slug }}" class="btn btn-sm btn-primary buy-link"
                           href="{{ url_for('shop.OrdersView:cart', publisher=publisher.slug) }}">{{ _('Add to cart') }}</a>
                    </li>
                </ul>
            </div>
            {% if loop.index is divisibleby 3 %}</div><div class="row">{% endif %}
        {% endfor %}
        </div>
        </div>
    {% endif %}
{% include "includes/pagination.html" %}
</div>
{% endblock %}

{% block final %}
    {{ super() }}
    <script>
        $('.buy-link').click(function (e) {
            var jqxhr = $.ajax({
                        url: "{{ url_for('shop.OrdersView:buy', publisher=publisher.slug)}}",
                        type: 'patch',
                        data: {product: this.id},
                        headers: {'X-CSRFToken': "{{ csrf_token() }}"},
                        dataType: 'json',
                        success: function (data) {
                            $c = $('#cart-counter')
                            $c.find('.badge').html(data.instance.total_items)
                            $c.addClass("bounce").one('animationend webkitAnimationEnd oAnimationEnd', function () {
                                $c.removeClass("bounce");
                            });
                            $c.addClass("highlight")
                        }
                    })
                    .fail(function (jqXHR) {
                        try {
                            var res = JSON.parse(jqXHR.responseText)
                            var err = res.message
                        } catch (e) {
                            var err = "Unknown error occurred"
                        }
                        flash_error(err, 'danger')
                    });
            e.preventDefault();
        });
    </script>
{% endblock %}
