{% extends "shop/_page.html" if not parent_template else parent_template %}

{% import 'includes/macros.html' as MACRO %}

{% block content_title %}{{ _('Cart') if order.status=='cart' else _('Order') }}{% endblock %}
{% block content_tagline %}{% endblock %}

{% block sidebar %}{{super()}}
{% if order.status != 'cart' %}
{% call(privileged) MACRO.AUTHORIZED(access_policy['order'].authorize('view')) %}
<ul class="nav nav-pills nav-stacked">
<li class="nav-header">{{ _('Actions') }}</li>
<li class="{{privileged}}">
  <a data-toggle="modal" data-target="#themodal" role="menuitem" tabindex="-1" href="{{url_for('mail.mail_view', mail_type='order', user=user.id, order=order.id)}}">
    <span class="glyphicon glyphicon-envelope"></span> {{ _('Send order mail') }}
  </a>
</li>
{% endcall %}
{% endif %}
{% endblock %}

{#
  What user can edit in different order stages:
  cart: editable list, editable quantity, address, editable comment
  ordered: editable comment, address
  paid: editable comment, address
  shipped: nothing editable
#}

{% block content %}{% block inline %}

{% if not order.order_lines %}
  <div class="jumbotron text-center">
    <h1>{{_('Nothing in cart, ')}}<br><a href="{{url_for('.product_list')}}">{{_('go shopping')}}</a></h1>
  </div>
{% else %}
  {% if order_form %}
  <form class="order-cart" method="post" action="{{order_form.action_url}}" autocomplete="on">
  {% endif %}

  {% include "shop/order_table.html" %}

  {% if order_form %}
    <div class="row">
      <div class="col-md-offset-8">
        <button type="submit" class="btn btn-success btn-block">{{ _('Save') }}</button>
        {% if order.status != 'cart' %}
          <a class="btn btn-warning btn-block" data-toggle="modal" data-target="#themodal" href="{{url_for('mail.mail_view', mail_type='compose', user=user.id,
          from_field=user.email, subject=gettext('Regarding order %(order)s', order=order.id))}}">
          {{ _('Contact Us') }}</a>
        {% elif stripe_key %}
          <button type="submit" id="checkout" class="btn btn-primary btn-block btn-lg">{{ _('Checkout') }}</button>
        {% endif %}
      </div>
    </div>
  {{ order_form.csrf_token }}
  {{ order_form.stripe_token }}
  </form>
  {% else %}
  <div class="row">
    <div class="col-md-offset-8">
        <a class="btn btn-warning" data-toggle="modal" data-target="#themodal" href="{{url_for('mail.mail_view', mail_type='compose', user=user.id,
        from_field=user.email, subject=gettext('Regarding order %(order)s', order=order.id))}}">
        {{ _('Contact Us') }}</a>
    <a href="{{url_for('.order_form_edit', order=order.id)}}" class="btn btn-primary">{{ _('Edit') }}</a>
  </div>
</div>
  {% endif %}
{% endif %}
{% endblock %}{% endblock %}

{% block final %}
{{super()}}
{% if order_form %}
<script src="https://checkout.stripe.com/checkout.js"></script>
<script>
{% if order.status=='cart' %}
  var handler = StripeCheckout.configure({
    key: '{{stripe_key}}',
    image: '{{ url_for('static', filename='img/helmgast_512px.png',) }}',
    token: function(token) {
      $('#stripe_token').val(token.id)
      $('.order-cart').submit()
      // Use the token to create the charge with a server-side script.
      // You can access the token ID with `token.id`
    }
  });

  $('#checkout').on('click', function(e) {
    e.preventDefault();
    handler.open({
      name: 'Helmgast',
      description: '{{order}}',
      currency: "sek",
      amount: 2000,
      panelLabel: "{{ _('Pay') }}",
      email: "{{order.user.email}}"
    });
  });

  // function calcTotal(e) {
  //   var $prod = $(e.delegateTarget)
  //   var qty = parseInt((e.target && e.target.value) || "0")
  //   var price = parseFloat(/[0-9.,]+/.exec($prod.find('.product-price').text())[0])
  //   var total = $prod.find('.product-total').text()
  //   total = total.replace(/[0-9.,]+/, qty*price)
  //   $prod.find('.product-total').text(total)
  //   calcGrandtotal()
  // }
  // function calcGrandtotal(e) {
  //   var grandtot = $('.product-subtotals .product-price')
  //   var sum = 0.0, num=0
  //   $('.product').each(function() {
  //     sum += parseFloat(/[0-9.,]+/.exec($(this).find('.product-total').text())[0])
  //     num += parseInt($(this).find('.product-quantity').val())
  //   })
  //   grandtot.text(grandtot.text().replace(/[0-9.,]+/, sum))
  //   $('#cart-counter').text(num)
  // }
  // $('.product').on('change', '.product-quantity', calcTotal)
  // $('.product-list').on('rac.removed', calcGrandtotal)
  // $('.product').each(function() {
  //   calcTotal({delegateTarget:this,target:$(this).find('.product-quantity')[0]})
  // })
{% endif %}
// $('#formsave').click(function(e){
//   $.post('{{order_form.action_url}}', $('.order-cart').serialize());
// })
</script>
{% endif %}
{% endblock %}
