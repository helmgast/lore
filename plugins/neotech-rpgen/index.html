{% extends "world/article_list.html" %}

{% import 'includes/elements.html' as el %}

{% block googlefonts %}{{ super() }}|Orbitron|Nova+Sans|Audiowide|Nova+Square{% endblock %}

{% set canedit = access_policy['article'].authorize('edit', res=article) %}
{% set isedit = args.get('intent', None) in ['patch', 'post'] %}

{% block cssimports %}
    {{ super() }}
    <link rel="stylesheet" href="https://unpkg.com/buefy/lib/buefy.min.css">
    <link rel="stylesheet" href="//cdn.materialdesignicons.com/2.0.46/css/materialdesignicons.min.css">
    <style>

        body {
            background-color: white
        }

        .navbar-default .navbar-collapse {
            width: 100%; /* TODO fix as we mix Bulma and Bootstrap */
        }

        .navbar {
            display: unset; /* TODO fix as we mix Bulma and Bootstrap */
        }

        .neotech .dark-label > .field, .neotech .dark-label > tr {
            background-color: #c0519e;
            background: linear-gradient(45deg, white 3px, #c0519e 3px);
            font-size: 0.9rem;

        }

        .neotech .light-label > .field {
            background-color: #daa3ca;
            background: linear-gradient(45deg, white 3px, #daa3ca 3px);
            font-size: 0.75rem;
        }

        .neotech fieldset[disabled] input, .neotech fieldset[disabled] select {
            background-color: #f7f7f7;
        }

        .neotech fieldset[disabled] button {
            display: none;
        }

        .skill {
            width: 2.25em;
        }

        .neotech.content figure {
            margin-left: 0;
            margin-right: 0;
        }

        .neotech figure.passphoto button {
            position: absolute;
            top: 5px;
            left: 5px;
        }

        .neotech figure.passphoto img {
            height: 180px;
            width: auto;
        }

        fieldset .column {
            padding-bottom: 0rem;
        }

        .neotech .field-label {
            margin-right: 20px;
        }

        .neotech .field input, .neotech .field select {
            border-radius: 0px !important;
            border-color: #c0519e;
            font-family: "Nova Square", "Arial", sans-serif;
        }

        .neotech {
            font-family: "Nova Sans", "Arial", sans-serif;
        }

        .neotech .erf-table-wide {
            width: 50%;
        }

        .neotech label {
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-family: "Orbitron", "Arial", sans-serif;
            font-weight: bold;
            text-align: left;
            color: white;
            height: 100%;
            min-width: 125px;
            vertical-align: top;
            padding: 4px;
        }

        .neotech label.normal-label {
            font-family: unset;
            color: unset;
            letter-spacing: unset;
            text-transform: unset;
        }

        .neotech h2 {
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-family: "Orbitron", "Arial", sans-serif;
            font-weight: bold;
            margin-bottom: 0px;
        }

        .neotech .intro {
            font-size: 0.7em;
            line-height: 1;
        }

        .neotech h2, .neotech legend {
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-family: "Nova Square", "Arial", sans-serif;
            font-weight: bold;
            color: white;
            text-align: center;
            background: linear-gradient(135deg, transparent 5px, #399dd6 5px);
            padding: 8px 4px;
        }

        .neotech .third {
            width: 32%;
            display: inline-block;
        }

        .neotech .erfarenhet {
            margin-bottom: 0px;
        }

        .neotech .erfarenhet .control {
            line-height: unset;
        }

        .neotech h3, .neotech th {
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-family: "Nova Square", "Arial", sans-serif;
            font-weight: bold;
            color: white;
            background-color: #c0519e;
            padding: 4px;
        }

        .el-input input {
            border-radius: 0px;
        }

        .el-text input {

            margin: 3px 0px;
            height: unset;
            box-shadow: none;
            -webkit-box-shadow: none;
            border: 1px solid #c0519e;
        }

        .neotech th {
            font-size: 12px;
        }

        .neotech fieldset {
            margin-bottom: 1em;
        }

        .neotech legend {
            margin-bottom: 5px;
        }

        .el-input__prefix {
            left: -4px;
            height: 42px;
            top: 3px;
        }

        .el-input--prefix .el-input__inner {
            padding-left: 125px;
        }

        .control {
            line-height: 2.25;
        }

        .control .dropdown-item {
            text-decoration: none;
            white-space: unset;
        }

        @keyframes rotating {
            100% {
                transform: rotate(360deg);
            }
        }

        [v-cloak]:before {
            content: "";
            border-radius: 50%;
            width: 100px;
            height: 100px;
            border: 6px solid rgba(0, 0, 0, 0.1);
            border-top: 6px solid #555;
            animation: rotating 1.2s infinite cubic-bezier(0.785, 0.135, 0.15, 0.86);
            visibility: visible;
            display: block;
            margin-left: 50%;
        }

        [v-cloak] {
            visibility: hidden;
        }

        .neotech .dotted .form-control {
            padding: 2px 4px;
            margin: 6px 4px;
            border: none;
            border-bottom: 1px dotted #c0519e;
        }

        .neotech .control.small-entry {
            font-size: 10px;
            line-height: 1;
            padding: 4px;
            width: 100px;
            flex-grow: 1;
        }

        .wide {
            width: 100%;
        }

    </style>

{% endblock %}

{% block js_bottom %}
    {{ super() }}
    <script type="application/javascript" src="https://vuejs.org/js/vue.js"></script>
    <script src="https://unpkg.com/buefy@0.6.3/lib/index.js"></script>
    <script src="//widget.cloudinary.com/global/all.js" type="text/javascript"></script>

    <script>
        Vue.use(Buefy.default);

        function _support_html5_storage() {
            try {
                return 'localStorage' in window && window['localStorage'] !== null;
            } catch (e) {
                return false;
            }
        }

        let REDIRECT = "{{ url_for('auth.sso', next=request.url) if not g.user else ''}}"

        let c = {
            person: {
                namn: '',
                kön: '',
                subkultur: '',
                koncept: '',
                sug1: '',
                sug2: '',
                utseende: '',
                soceko: '',
            },
            kompetens: {
                edu: {
                    attribut: 1,
                    medicin: 0,
                    natur: 0,
                    humaniora: 0,
                    teknologi: 0,
                },
                karisma: {
                    attribut: 1,
                    boss: 0,
                    empati: 0,
                    pr: 0,
                    yao: 0,
                },
                kreativitet: {
                    attribut: 1,
                    hacking: 0,
                    mek: 0,
                    media: 0,
                    avantgarde: 0,
                },
                primal: {
                    attribut: 1,
                    budo: 0,
                    guns: 0,
                    flex: 0,
                    hardcore: 0,
                },
                cortex: {
                    attribut: 1,
                    biz: 0,
                    virr: 0,
                    perception: 0,
                    reaktion: 0,
                },
                ronin: {
                    attribut: 1,
                    offgrid: 0,
                    krim: 0,
                    skugga: 0,
                    gatan: 0,
                }
            },
            cv: [],  // first item is top level CV row, an object with {kontrakt, erfarenhet}
            edges: [
                // {titel: '', kompetens: ''}
            ],
            image: '',
        };
        let val = $('#characterdata__stats').val() || '{}'
        if (val.length <= 2 && _support_html5_storage() && localStorage.neotechrpgen != undefined) {
            val = localStorage.neotechrpgen;
            localStorage.clear();
        }
        $.extend(true, c, JSON.parse(val));


        var vm = new Vue({
            el: '#form',
            data: {
                c: c,
                email: '',
                list_subkultur: [],
                list_betongbasare: [],
                list_kuberkontor: [],
                list_darknetdisorder: [],
                list_moneymammon: [],
                list_gunsgrit: [],
                list_karriar: [],
                list_koncept: [],
                list_kon: [],
                list_utseende: [],
                list_namn: [],
                list_sug: [],
                lists: {
                    'Betong & basare': 'list_betongbasare',
                    'Kuber & kontor': 'list_kuberkontor',
                    'Darknet & disorder': 'list_darknetdisorder',
                    'Guns, guts & grit': 'list_gunsgrit',
                    'Money & mammon': 'list_moneymammon'
                },
                list_updated: new Date(),
                chosen_karriär: '',
            },
            computed: {
                filtered_karriar: function () {
                    let data = this
                    return data.c.cv.map(function (line, i) {
                        let fixed_karriär = ''
                        if (data.c.cv[i - 1]) {
                            if (data.cv_erfarenhet_details[i - 1].beskrivning.indexOf('KARRIÄRSBYTE') < 0) {
                                fixed_karriär = data.cv_kontrakt_details[i - 1].karriär
                            }
                        }
                        return data.list_karriar.filter((opt) => {
                            return opt.kontrakt
                                .toString()
                                .toLowerCase()
                                .indexOf(line.kontrakt.toLowerCase()) >= 0 && (!fixed_karriär || opt.karriär === fixed_karriär)
                        })
                    })

                },
                cv_kontrakt_details: function () {
                    let data = this
                    return data.c.cv.map(function (line) {
                        let found = data.list_karriar.find(el => el.kontrakt === line.kontrakt)
                        return found ? found : {kontrakt: '', karriär: '', tabell: ''}
                    })
                },
                cv_erfarenhet_details: function () {
                    let data = this
                    let k_counter = 0, last_karriär = ''
                    let out = data.c.cv.map(function (line) {
                        let kontrakt_info = data.list_karriar.find(el => el.kontrakt === line.kontrakt)
                        let erf_info = {erfarenhet: '', beskrivning: '', bonus: ''}
                        if (kontrakt_info) {
                            if (kontrakt_info.karriär == last_karriär) {
                                k_counter += 1
                            } else {
                                last_karriär = kontrakt_info.karriär
                            }
                            let bonus = k_counter * 20
                            let lookup = parseInt(line.erfarenhet) + bonus
                            lookup = lookup - Math.ceil((lookup-100) / 20)*20
                            let list = data.lists[kontrakt_info.tabell]
                            if (list && data[list][lookup]) {
                                erf_info = data[list][lookup]
                                erf_info.bonus = bonus
                            }
                        }
                        return erf_info

                    });
                    console.log(out)
                    return out;
                },
                attributpoäng: function () {
                    let data = this
                    let periods = data.c.cv.length
                    let pool = 0
                    if (periods <= 2) {
                        pool = 16+6
                    } else if (periods <=5) {
                        pool = 14+6
                    } else if (periods <=8) {
                        pool = 12+6
                    } else if (periods <=11) {
                        pool = 10+6
                    } else {
                        pool = 8+6
                    }
                    return pool - data.c.kompetens.edu.attribut -
                        data.c.kompetens.karisma.attribut -
                        data.c.kompetens.kreativitet.attribut -
                        data.c.kompetens.primal.attribut -
                        data.c.kompetens.cortex.attribut -
                        data.c.kompetens.ronin.attribut
                },
                kompetenspoäng: function () {
                    let data = this
                    let periods = data.c.cv.length
                    let pool = 0

                    if (periods <= 2) {
                        pool = 30
                    } else if (periods <=5) {
                        pool = 40
                    } else if (periods <=8) {
                        pool = 50
                    } else if (periods <=11) {
                        pool = 60
                    } else {
                        pool = 70
                    }
                    for (const attr in c.kompetens) {
                        for (const komp in c.kompetens[attr]) {
                            if (komp != 'attribut') {
                                pool = pool - c.kompetens[attr][komp]
                            }
                        }
                    }
                    return pool

                }
            },
            methods:
                {
                    randInt: function (min, max, toast = true) {
                        let roll = Math.floor(Math.random() * (max - min + 1)) + min;
                        if (toast)
                            this.$toast.open('Slog ' + roll)
                        return roll
                    }
                    ,
                    randList: function (list, concat = true) {
                        let len = list.length
                        let out = ''
                        if (len) {
                            if (concat) {
                                for (k of Object.keys(list[0])) {
                                    let i = this.randInt(0, len - 1, toast = false)
                                    out += list[i][k].trim() + ' '
                                }
                                return out.trim()
                            } else {
                                let i = this.randInt(0, len - 1, toast = false)
                                return list[i]
                            }
                        }

                    },
                    lookup_table: function (table, lookup, property) {
                        var thetable = 'list_' + table;
                        if (thetable in this) {
                            while (lookup < 101 && this[thetable][lookup] && !this[thetable][lookup].erfarenhet) {
                                lookup++;
                            }
                            let found = this[thetable][lookup];
                            return found ? found[property] : ''
                        }
                    }
                    ,
                    lookup_by_value: function (table, value, property) {
                        var thetable = 'list_' + table;
                        if (thetable in this) {
                            let found = this[thetable].find(el => el.value === value)
                            return found ? found[property] : ''
                        }
                    }
                    ,
                    add_kontrakt: function () {
                        let år = 2070
                        if (this.c.cv.length > 0) {
                            år = this.c.cv[this.c.cv.length - 1].år - 4;
                        }
                        this.c.cv.push({år: år, kontrakt: '', erfarenhet: ''})
                    },
                    remove_kontrakt: function (index) {
                        this.c.cv.splice(index, 1);
                    },
                    select_kontrakt: function (kontrakt) {
                        /*
                        if (kontrakt) {
                            let komp = kontrakt.kompetens.substr(1).toLowerCase()
                            for (const attr in c.kompetens) {
                                if (c.kompetens[attr].hasOwnProperty(komp)) {
                                    c.kompetens[attr][komp] = 6
                                }
                            }
                        }
                        */
                    },
                    select_image: function () {
                        cloudinary.openUploadWidget(
                            {
                                cloud_name: 'helmgast',
                                upload_preset: 'q59fkfe8',
                                sources: ['local', 'url'],
                                theme: 'minimal'
                            },
                            function (error, result) {
                                if (!error && result) {
                                    c.image = result[0].secure_url
                                } else {
                                    console.log(error, result)
                                }
                            });
                    }
                }
            ,
            delimiters: ["<%", "%>"]
        });

        function getSpreadsheet(key, sheet, list, processor) {
            let url = `https://spreadsheets.google.com/feeds/list/${key}/${sheet}/public/values?alt=json-in-script`
            fetchJsonp(url).then(function (response) {
                return response.json()
            }).then(function (json) {
                if (json.feed.entry.length) {
                    let cols = Object.keys(json.feed.entry[0]).filter(function (prop) {
                        return prop.indexOf('gsx$') == 0
                    })
                    let out = json.feed.entry.map(function (entry) {
                        let rv = {}
                        for (k of cols) {
                            rv[k.substring(4)] = entry[k].$t
                        }
                        return rv

                    })
                    vm.$data[list] = processor ? processor(out) : out
                    if (json.feed.updated.$t) {
                        let d = new Date(json.feed.updated.$t)
                        if (d > vm.list_updated) {
                            vm.list_updated = d
                            console.log(d)
                        }
                    }
                }
            }).catch(function (ex) {
                console.log('parsing failed', ex)
            });
        }

        function tableize(list) {
            let newlist = []
            for (l of list) {
                parts = l.t100.replace(/\(.*\)/g, '').match(/\d+/g)
                fr = parseInt(parts[0]);
                to = parseInt(parts[1]) || fr;
                if (fr && to) {
                    for (let i = fr; i < (to + 1); i++) {
                        newlist[i] = l
                    }
                }
            }
            return newlist;
        }

        getSpreadsheet('1AGbbY6nk8KRZWtxc_25DcSlR0ePo4s6gDYxYfKDuxaI', 'od6', 'list_subkultur')
        getSpreadsheet('1AGbbY6nk8KRZWtxc_25DcSlR0ePo4s6gDYxYfKDuxaI', 'ow4hm3n', 'list_karriar')
        getSpreadsheet('1AGbbY6nk8KRZWtxc_25DcSlR0ePo4s6gDYxYfKDuxaI', 'oxfl1ya', 'list_utseende',)
        getSpreadsheet('1AGbbY6nk8KRZWtxc_25DcSlR0ePo4s6gDYxYfKDuxaI', 'ozaq8cr', 'list_koncept',)
        getSpreadsheet('1AGbbY6nk8KRZWtxc_25DcSlR0ePo4s6gDYxYfKDuxaI', 'ocggd2p', 'list_kon',)
        getSpreadsheet('1AGbbY6nk8KRZWtxc_25DcSlR0ePo4s6gDYxYfKDuxaI', 'ompcwg4', 'list_sug',)
        getSpreadsheet('1AGbbY6nk8KRZWtxc_25DcSlR0ePo4s6gDYxYfKDuxaI', 'olwm092', 'list_namn',)


        getSpreadsheet('1nuMBrtMQLoGnVNOOcImtQiLwB0smLNu2KwWys26mM0U', 'obi8iy0', 'list_betongbasare', tableize)
        getSpreadsheet('1nuMBrtMQLoGnVNOOcImtQiLwB0smLNu2KwWys26mM0U', 'o22l8ex', 'list_darknetdisorder', tableize)
        getSpreadsheet('1nuMBrtMQLoGnVNOOcImtQiLwB0smLNu2KwWys26mM0U', 'obhz2o1', 'list_gunsgrit', tableize)
        getSpreadsheet('1nuMBrtMQLoGnVNOOcImtQiLwB0smLNu2KwWys26mM0U', 'ovsuh6q', 'list_kuberkontor', tableize)
        getSpreadsheet('1nuMBrtMQLoGnVNOOcImtQiLwB0smLNu2KwWys26mM0U', 'okdtkyc', 'list_moneymammon', tableize)


        $('#articleform').submit(function (e) {
            let json = JSON.stringify(vm.c);
            $('#characterdata__stats').val(json)
            $('#title').val(vm.c.person.namn);
            $('#cloudinary').val(vm.c.image);
            // Store submit data in case we need to redirect to login
            if (_support_html5_storage()) {
                localStorage.neotechrpgen = json;
            }
            if (REDIRECT) {
                window.location.replace(REDIRECT)
                e.preventDefault();
            }

        })

    </script>
{% endblock %}

{% block title %}{% if args.get('intent', None) == 'post' %}Gör en Neotech-karaktär{% else %}{{ article.title }}
{% endif %}{% endblock %}

{% block header %}
    {% if args.get('intent', None) in ['patch','post'] %}
        {# We are editing #}
        <form id="articleform" method="post" action="{{ action_url }}">
        {{ article_form.csrf_token }}
        {{ article_form.characterdata.stats(class='hide') }}
        {{ article_form.title(class="hide") }}
        {{ article_form.cloudinary(class="hide") }}


    {% else %}
        {# We are viewing #}
        <textarea class="hide" id="characterdata__stats">{{ article.characterdata.stats|tojson|safe }}</textarea>
        {% if not canedit %}  {# Just viewing #}
            <div class="alert alert-info" role="alert">
                Göra en egen karaktär? <a class="btn btn-small btn-success"
                                          href="{{ url_for('world.ArticlesView:get', id='post', world_=world.slug, type='character', theme="neotech-rpgen") }}">Klicka
                här</a>
            </div>
        {% endif %}
    {% endif %}

    {% if article_form and article_form.title.errors %}
        <div class="alert alert-danger" role="alert">
            Namn: {{ article_form.title.errors|join(' ') }}
        </div>
    {% endif %}

    {#    {{ super() }}#}
    {% if args.get('intent', None) %}

    {% else %}
    {% endif %}

{% endblock %}

{% block main %}
    <div class="container">
        <div class="row">
            <div class="col-lg-9">
                <div class="content neotech" id="form" class="is-loading" v-cloak>
                    <div class="columns">
                        <div class="column is-one-third">
                            <figure class="image"><img
                                    src="{{ url_for('plugins', filename='neotech-rpgen/nimrod.svg', _external=true, _scheme='') }}">
                            </figure>
                        </div>
                        <div class="column"><h2>Välkommen till Gig Finder!</h2><br>
                            <small class="intro"><em>Solsystemets största och bästa jobbsökarnätverk. Vi förmedlar
                                dagligen över 100 miljoner kontakter och över 2 miljoner gig till arbetshungriga users
                                över hela monde. Fyll i dina detaljer!</em></small>
                        </div>
                    </div>
                    <fieldset {{ 'disabled' if not isedit }} class="dark-label">
                        <legend>Personlighet</legend>
                        <div class="columns">
                            <div class="column is-two-third dark-label">
                                {{ el.text("Namn", id="c.person.namn", list="list_namn") }}
                                {{ el.text("Kön", id="c.person.kön", list="list_kon") }}

                                <b-field horizontal label="Subkultur">
                                    <b-field>
                                        <b-autocomplete
                                                v-model="c.person.subkultur"
                                                :data="list_subkultur"
                                                field="subkultur"
                                                placeholder="Välj subkultur"
                                                icon="magnify"
                                                expanded
                                                open-on-focus
                                                @select="option => c.person.subkultur = option.subkultur">
                                            <template slot-scope="props">
                                                <p>
                                                    <strong><% props.option.subkultur %></strong>
                                                    <br>
                                                    <small><% props.option.beskrivning %></small>
                                                </p>
                                            </template>
                                        </b-autocomplete>
                                        <p class="control">
                                            <button v-on:click="c.person.subkultur = randList(list_subkultur, false).subkultur"
                                                    type="button"
                                                    class="button is-info">
                                                <b-icon icon="dice-multiple"></b-icon>
                                            </button>
                                        </p>
                                    </b-field>
                                </b-field>
                                <b-field horizontal label="SocEko-nivå">
                                    <b-field>

                                        <b-select v-model="c.person.soceko" name="c.person.soceko"
                                                  placeholder="Välj nivå"
                                                  expanded>
                                            <option value="Shacker">Shacker</option>
                                            <option value="Basare">Basare</option>
                                            <option value="Löneslav">Löneslav</option>
                                            <option value="Paladin">Paladin</option>
                                        </b-select>
                                        {#                                        <p class="control">#}
                                        {#                                            <button type="button"#}
                                        {#                                                    class="button is-info">#}
                                        {#                                                <b-icon icon="dice-multiple"></b-icon>#}
                                        {#                                            </button>#}
                                        {#                                        </p>#}
                                    </b-field>
                                </b-field>
                            </div>
                            <div class="column is-one-third dark-label">
                                <figure class="image passphoto">
                                    <img v-if="c.image" :src="c.image">
                                    <img v-else src="https://bulma.io/images/placeholders/640x480.png">
                                    {% if isedit %}
                                        <button v-on:click="select_image" class="button is-small" type="button">Välj
                                            bild
                                        </button>
                                    {% endif %}
                                </figure>

                            </div>
                        </div>
                        {{ el.text("Sug", id="c.person.sug1", list="list_sug") }}
                        {{ el.text("Sug", id="c.person.sug2", list="list_sug") }}

                        {{ el.text("Koncept", id="c.person.koncept", list="list_koncept") }}
                        {{ el.text("Utseende", id="c.person.utseende", list="list_utseende") }}


                    </fieldset>
                    <fieldset {{ 'disabled' if not isedit }}>
                        <legend>CV</legend>
                        <b-table :data="c.cv">
                            <template slot-scope="props">
                                <b-table-column label="År" width="40" numeric>
                                    <% props.row.år %>
                                    <br><br>
                                    <button v-if="props.index == c.cv.length-1" type="button"
                                            v-on:click="remove_kontrakt(props.index)" class="delete"></button>
                                </b-table-column>

                                <b-table-column label="Kontrakt">
                                    <b-autocomplete size="is-small"
                                                    open-on-focus
                                                    clear-on-select
                                                    v-model="props.row.kontrakt"
                                                    field="kontrakt"
                                                    icon="magnify"
                                                    :data="filtered_karriar[props.index]"
                                                    placeholder="Välj kontrakt"
                                                    @select="option => select_kontrakt(option)">
                                    </b-autocomplete>
                                    <p v-if="props.row.kontrakt">
                                        <small>
                                            <strong>Kompetens</strong>: +1 i
                                            <%cv_kontrakt_details[props.index].kompetens%>
                                        </small>
                                    </p>
                                </b-table-column>

                                <b-table-column label="Karriär">
                                    <p v-if="props.row.kontrakt">
                                        <% cv_kontrakt_details[props.index].karriär %><br>
                                        <small>+1 i <% cv_kontrakt_details[props.index].attribut %></small>
                                    </p>
                                </b-table-column>

                                <b-table-column label="Erfarenhet" class="erf-table-wide">
                                    <b-field v-if="props.row.kontrakt" class="erfarenhet">
                                        <p class="control">
                                            <button type="button" v-on:click="props.row.erfarenhet = randInt(1,101)"
                                                    class="button is-dark is-small">
                                                <b-icon
                                                        icon="dice-multiple"
                                                        size="is-small">
                                                </b-icon>
                                            </button>
                                        </p>
                                        <b-input size="is-small" v-model="props.row.erfarenhet" type="number" :min=1
                                                 :max=150></b-input>
                                        <p class="control">
                                            <a class="button is-static is-small">+<%cv_erfarenhet_details[props.index].bonus%></a>

                                        </p>
                                        <label class="normal-label">
                                            <% cv_erfarenhet_details[props.index].erfarenhet %> (<%
                                            cv_kontrakt_details[props.index].tabell %>)
                                        </label>

                                    </b-field>
                                    <small> <% cv_erfarenhet_details[props.index].beskrivning %></small>

                                </b-table-column>

                            </template>


                        </b-table>

                        <p class="control">
                            <button type="button" v-on:click="add_kontrakt()" class="button is-dark is-small">Lägg till
                                period
                            </button>
                            <button v-if="c.cv.length > 0" type="button" v-on:click="add_kontrakt()"
                                    class="button is-dark is-small">Gå till uppväxt
                            </button>
                        </p>
                    </fieldset>
                    <fieldset {{ 'disabled' if not isedit }}>
                        <legend>Attribut & kompetenser
                            {{ el.computed2("attributpoäng", label="Attributpoäng kvar") }}</legend>
                        <div class="columns">
                            <fieldset class="dark-label column is-one-third">
                                {% call el.number("Edu", id="c.kompetens.edu.attribut", max=6, min=1) %}{% endcall %}
                                <fieldset class="light-label">
                                    {% call el.number("Medicin", id="c.kompetens.edu.medicin") %}
                                        {{ el.computed("c.kompetens.edu.medicin+c.kompetens.edu.attribut") }}{% endcall %}
                                    {% call el.number("Humaniora", id="c.kompetens.edu.humaniora") %}
                                        {{ el.computed("c.kompetens.edu.humaniora+c.kompetens.edu.attribut") }}{% endcall %}
                                    {% call el.number("Natur", id="c.kompetens.edu.natur") %}
                                        {{ el.computed("c.kompetens.edu.natur+c.kompetens.edu.attribut") }}{% endcall %}
                                    {% call el.number("Teknologi", id="c.kompetens.edu.teknologi") %}
                                        {{ el.computed("c.kompetens.edu.teknologi+c.kompetens.edu.attribut") }}{% endcall %}
                                </fieldset>
                            </fieldset>
                            <fieldset class="dark-label column is-one-third">
                                {% call el.number("Karisma", id="c.kompetens.karisma.attribut", max=6, min=1) %}{% endcall %}
                                <fieldset class="light-label">

                                    {% call el.number("Boss", id="c.kompetens.karisma.boss") %}
                                        {{ el.computed("c.kompetens.karisma.boss+c.kompetens.karisma.attribut") }}{% endcall %}
                                    {% call el.number("Empati", id="c.kompetens.karisma.empati") %}
                                        {{ el.computed("c.kompetens.karisma.empati+c.kompetens.karisma.attribut") }}{% endcall %}
                                    {% call el.number("PR", id="c.kompetens.karisma.pr") %}
                                        {{ el.computed("c.kompetens.karisma.pr+c.kompetens.karisma.attribut") }}{% endcall %}
                                    {% call el.number("Yao", id="c.kompetens.karisma.yao") %}
                                        {{ el.computed("c.kompetens.karisma.yao+c.kompetens.karisma.attribut") }}{% endcall %}
                                </fieldset>

                            </fieldset>
                            <fieldset class="dark-label column is-one-third">
                                {% call el.number("Kreativitet", id="c.kompetens.kreativitet.attribut", max=6, min=1) %}{% endcall %}
                                <fieldset class="light-label">

                                    {% call el.number("Hacking", id="c.kompetens.kreativitet.hacking") %}
                                        {{ el.computed("c.kompetens.kreativitet.hacking+c.kompetens.kreativitet.attribut") }}{% endcall %}
                                    {% call el.number("Mek", id="c.kompetens.kreativitet.mek") %}
                                        {{ el.computed("c.kompetens.kreativitet.mek+c.kompetens.kreativitet.attribut") }}{% endcall %}
                                    {% call el.number("Media", id="c.kompetens.kreativitet.media") %}
                                        {{ el.computed("c.kompetens.kreativitet.media+c.kompetens.kreativitet.attribut") }}{% endcall %}
                                    {% call el.number("Avantgarde", id="c.kompetens.kreativitet.avantgarde") %}
                                        {{ el.computed("c.kompetens.kreativitet.avantgarde+c.kompetens.kreativitet.attribut") }}{% endcall %}
                                </fieldset>
                            </fieldset>
                        </div>
                        <div class="columns">

                            <fieldset class="dark-label column is-one-third">
                                {% call el.number("Primal", id="c.kompetens.primal.attribut", max=6, min=1) %}{% endcall %}
                                <fieldset class="light-label">

                                    {% call el.number("Budo", id="c.kompetens.primal.budo") %}
                                        {{ el.computed("c.kompetens.primal.budo+c.kompetens.primal.attribut") }}{% endcall %}
                                    {% call el.number("Guns", id="c.kompetens.primal.guns") %}
                                        {{ el.computed("c.kompetens.primal.guns+c.kompetens.primal.attribut") }}{% endcall %}
                                    {% call el.number("Flex", id="c.kompetens.primal.flex") %}
                                        {{ el.computed("c.kompetens.primal.flex+c.kompetens.primal.attribut") }}{% endcall %}
                                    {% call el.number("Hardcore", id="c.kompetens.primal.hardcore") %}
                                        {{ el.computed("c.kompetens.primal.hardcore+c.kompetens.primal.attribut") }}{% endcall %}
                                </fieldset>
                            </fieldset>

                            <fieldset class="dark-label column is-one-third">
                                {% call el.number("Cortex", id="c.kompetens.cortex.attribut", max=6, min=1) %}{% endcall %}
                                <fieldset class="light-label">

                                    {% call el.number("Biz", id="c.kompetens.cortex.biz") %}
                                        {{ el.computed("c.kompetens.cortex.biz+c.kompetens.cortex.attribut") }}{% endcall %}
                                    {% call el.number("Virr", id="c.kompetens.cortex.virr") %}
                                        {{ el.computed("c.kompetens.cortex.virr+c.kompetens.cortex.attribut") }}{% endcall %}
                                    {% call el.number("Perception", id="c.kompetens.cortex.perception") %}
                                        {{ el.computed("c.kompetens.cortex.perception+c.kompetens.cortex.attribut") }}{% endcall %}
                                    {% call el.number("Reaktion", id="c.kompetens.cortex.reaktion") %}
                                        {{ el.computed("c.kompetens.cortex.reaktion+c.kompetens.cortex.attribut") }}{% endcall %}
                                </fieldset>
                            </fieldset>

                            <fieldset class="dark-label column is-one-third">
                                {% call el.number("Ronin", id="c.kompetens.ronin.attribut", max=6, min=1) %}{% endcall %}
                                <fieldset class="light-label">

                                    {% call el.number("Offgrid", id="c.kompetens.ronin.offgrid") %}
                                        {{ el.computed("c.kompetens.ronin.offgrid+c.kompetens.ronin.attribut") }}{% endcall %}
                                    {% call el.number("Krim", id="c.kompetens.ronin.krim") %}
                                        {{ el.computed("c.kompetens.ronin.krim+c.kompetens.ronin.attribut") }}{% endcall %}
                                    {% call el.number("Skugga", id="c.kompetens.ronin.skugga") %}
                                        {{ el.computed("c.kompetens.ronin.skugga+c.kompetens.ronin.attribut") }}{% endcall %}
                                    {% call el.number("Gatan", id="c.kompetens.ronin.gatan") %}
                                        {{ el.computed("c.kompetens.ronin.gatan+c.kompetens.ronin.attribut") }}{% endcall %}
                                </fieldset>

                                {{ el.computed2("kompetenspoäng", label="Kompetenspoäng kvar") }}
                            </fieldset>
                        </div>

                    </fieldset>
                    <small>Tabelldata från: <% list_updated.toLocaleDateString() %></small>

                </div>
                {% if article_form %}
                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                        <div class="panel panel-default">
                            <div class="panel-heading" role="tab" id="headingOne">
                                <h4 class="panel-title">
                                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapseOne"
                                       aria-expanded="true" aria-controls="collapseOne">
                                        Artikel-detaljer
                                    </a>
                                </h4>
                            </div>
                            <div id="collapseOne" class="panel-collapse collapse" role="tabpanel"
                                 aria-labelledby="headingOne">
                                <aside class="panel-body">
                                    {% block asides %}
                                    {% endblock asides %}
                                </aside>
                            </div>
                        </div>
                    </div>
                    {{ MACRO.SAVE_BUTTON('articleform') }}
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}