{% extends "world/world_item.html" if not parent_template else parent_template %}

{% from 'includes/components.html' import form_field, form_fields %}

{% if op == 'new' %}
  {%set tagline = world.title %} {% set title = 'New article!' %}
{% else %}
  {% set tagline = article.type_name() %} {% set title = article.title %}
{% endif %}

{% set article_type_name = article.type_name().lower() if article else '' %}

{% block cssimports %}
{{ super() }}
<link href="http://fonts.googleapis.com/css?family=Gentium+Book+Basic:400,400italic,700,700italic" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
<!--[if lte IE 8]>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.ie.css" />
<![endif]-->
{% endblock %}

{% block jsimports %}{{super()}}
<script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
{% endblock %}

{%- block article_actions -%}{{ super() }}
{% if op!= 'new'%}
<li><a href="{{ url_for('.article_form_edit', world=world.slug, article=article.slug) }}"><span class="glyphicon glyphicon-edit"></span> Edit</a></li>
<li><a href="#deletemodal" data-toggle="modal"><span class="glyphicon glyphicon-trash"></span> Delete</a></li>
<li><a href="{{ url_for('.article_view', world=world.slug, article=article.slug) }}"><span class="glyphicon glyphicon-align-justify"></span> View</a></li>
{%endif%}
{%- endblock -%}

{% block middle %}

{#### FORM ####}
{% if article_form %}
<form id='articleform' method="post" action="{{ article_form.action_url }}">
{{ article_form.title(style="display:none;") }}
<div class="page-header" style="margin-bottom: 5px;">
  <h1 class="article_header"><span id="editable_title" class="contenteditable" contenteditable="True">{{title }}</span></h1>
</div>

{% include "includes/flash.html" %}
<div class="row">
<div class="col-md-7 article_text panel-group">
  {% if article and article.is_image() %}
  <img src="{{article.imagearticle.url}}" />
  {% endif %}
	<div class="btn-toolbar" data-role="editor-toolbar"
		data-target="#editor">
		<div class="btn-group btn-group-sm">
      <a class="btn btn-default" data-edit="bold" title="Bold" data-original-title="Bold (Ctrl/Cmd+B)"><span class="glyphicon glyphicon-bold"></span></a>
      <a class="btn btn-default" data-edit="italic" title="Italic" data-original-title="Italic (Ctrl/Cmd+I)"><span class="glyphicon glyphicon-italic"></span></a>
      {#<a class="btn btn-default" data-edit="markdown" title="Markdown">Markdown</a>#}
    </div>
    <div class="btn-group">
        <a class="btn btn-default" title="" id="pictureBtn" data-original-title="Insert picture (or just drag &amp; drop)"><i class="glyphicon glyphicon-picture"></i></a>
        <input type="file" data-role="magic-overlay" data-target="#pictureBtn" data-edit="insertImage" style="opacity: 0; position: absolute; top: 0px; left: 0px; width: 36px; height: 30px;">
      </div>
	</div>
  <div class="panel panel-default hide" id="editor">{{ article_form.content.data|markdown if article_form.content.data else '<p><br></p>'|safe}}
  </div>
  <span id="hinter"></span>
  {% set rows = (article_form.content.data|length // 32)+1 %}
  {{ article_form.content(**{'rows':rows, 'data-editable':'textarea', 'data-target':'#editor'}) }}
</div>
<div class="col-md-5 metadata">
  {% if g.user.id %}
  <input type="hidden" name="creator" value="{{g.user.id}}" />
  {% endif %}
  {{ article_form.csrf_token }}
  <button type="submit" class="btn btn-sm btn-primary">Save changes</button>
  <a href="{{ url_for('world.index') }}" data-dismiss="back" class="btn btn-sma">Cancel</a>
  <h4>Metadata</h4>
    <div class="panel panel-default">
    <div class="panel-heading">
      <h4 class="panel-title">
        <a data-toggle="collapse" data-parent="#accordion" href="#collapseDesc">
          Description <span class="glyphicon glyphicon-chevron-down"></span>
        </a>
      </h4>
    </div>
    <div id="collapseDesc" class="panel-collapse collapse">
      <div class="panel-body">
        {{article_form.description(style="width:100%")}}
      </div>
    </div>
  </div>
  {{ article_form.world(**{'data-role':'chosen'}) }} {# Makes nice select widget#}
  <fieldset style="margin-bottom: 10px">
  {#  {{ form_field(article_form.articlegroups) }} #}
  {{ form_field(article_form.type, class="m_action2")}}
  </fieldset>
  <div id="imagearticle_form" {{ ' class=hide ' if article_type_name!='image'}}>
  {{ form_fields(article_form.imagearticle) }}
  </div>
  <div id="personarticle_form" {{ ' class=hide ' if article_type_name!='person'}}>
  {{ form_fields(article_form.personarticle) }}
  </div>
  <div id="fractionarticle_form" {{ ' class=hide ' if article_type_name!='fraction'}}>
  {{ form_fields(article_form.fractionarticle) }}
  </div>
  <div id="placearticle_form" {{ ' class=hide ' if article_type_name!='place'}}>
  {{ form_fields(article_form.placearticle) }}
  </div>
  <div id="eventarticle_form" {{ ' class=hide ' if article_type_name!='event'}}>
  {{ form_fields(article_form.eventarticle) }}
  </div>
  <div id="campaignarticle_form" {{ ' class=hide ' if article_type_name!='campaign'}}>
  {{ form_fields(article_form.campaignarticle) }}
  </div>

  <h4 style="display:inline">Relations ({{ article.relations|length if article }})</h4>
  {{ article_form.relations() }}
  <button id="addrow" class="btn btn-info btn-sm{{' disabled' if op=='new'}}" style="margin-left: 10px; margin-bottom: 5px;">Add relation</button>
</div>
</div>
</form>


{#### PAGE ####}
{%- else -%}

<div class="page-header">
    <h1 class="article_header">{{title }}
        <small>{{ tagline }}</small>
    </h1>
<ul class="list-inline article-meta" style="margin-bottom: 0px">
  {% set articlegroups = article.articlegroups|list %}
  <li title="Creator"><span class="glyphicon glyphicon-user"></span> {% if article.creator %}<a href="{{url_for('social.user_view', user=article.creator.username)}}">{{article.creator}}</a>{% else %}System{%endif%}</li>
  <li title="Created"><span class="glyphicon glyphicon-calendar"></span> {{article.created_date.strftime('%Y-%m-%d') }}</li>
  <li title="Visibility"><span class="glyphicon glyphicon-lock"></span> {{ articlegroups|join(',') if articlegroups else 'All' }}</li>
  <li title="Relations to other articles"><i class="glyphicon glyphicon-export"></i> {{ article.relations|length }}</li>
  <li title="Other articles relation to this article"><i class="glyphicon glyphicon-import"></i> {{ 0 }}</li>
</ul>
<ul class="list-inline" style="margin-bottom: 0px;margin-left: -14px">
{% set article_type = article.type_name().lower() %}
{%- if article_type_name=='place' -%}
  <li><span class="nav-header" style="display:inline">Lon</span>{{article.coordinate_x}}</li>
  <li><span class="nav-header" style="display:inline">Lat</span>{{article.coordinate_y}}</li>
  <li><span class="nav-header" style="display:inline">Type</span>{{article.location_type }}</li>
{%- elif article_type_name=='image' -%}
  <li><span class="nav-header" style="display:inline">Type</span>{{article.mime_type}}</li>
  <li><span class="nav-header" style="display:inline">URL</span><a href="{{article_type.url}}">{{article.url|truncate(30, True)}}</a></li>
{%- elif article_type_name=='event' -%}
  <li><span class="nav-header" style="display:inline">Started</span>{{article.from_date}}</li>
  <li><span class="nav-header" style="display:inline">Ended</span>{{article.to_date}}</li>
{%- elif article_type_name=='person' and article.personarticle -%}
  <li><span class="nav-header" style="display:inline">Born</span>{{article.personarticle.born}}</li>
  <li><span class="nav-header" style="display:inline">Died</span>{{article.personarticle.died}}</li>
  <li><span class="nav-header" style="display:inline">Gender</span>{{article.personarticle.gender_name() }}</li>
  <li><span class="nav-header" style="display:inline">Occupation</span>{{article.personarticle.occupation}}</li>
{%- endif -%}
</ul>
</div>

{% include "includes/flash.html" %}
{% if article.description %}
<div class="col-md-9">{{article.description}}</div>
{% endif %}
<div class="article col-md-9 article_text">
	{% if article.is_image() %} <img src="{{url_for('.image', slug=article.slug)}}" />
	{% endif %} {{ article.content|markdown }}
</div>

{% if article_type_name == 'blogpost' %}
<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'fablr'; // required: replace example with your forum shortname

/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
{% endif %}

{% endif %} {% endblock %}

{% block final %}
{% if article %}
<div class="modal fade bs-modal-sm" id="deletemodal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-sm">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">Are you sure you want to delete {{article.title}}?</h4>
      </div>
      <div class="modal-body">
        <form id='deleteform' method="post" action="{{ url_for('.article_delete', world=world.slug, article=article.slug, op="DELETE")}}">
          <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Yes</button> 
        </form>
      </div>
    </div>
  </div>
</div>
{% endif %}
{{super()}}

{% if article_form %}
<script>
	$(document).ready(
			function() {
        //----------------------------------
        $('#editable_title')
          .blur(function(e) {
            $('#title').val(this.textContent); })
          .on('paste', function(e) {
            $this = $(this)
            setTimeout(function() {
              $this.html($this.text()); // clean the html
            }, 100);})
          .focus();

        //----------------------------------
        {% if article %} {# TODO should work also when article is None! #}
        // Editable-list START
        var getButtonObj = function() {
          var $button = $("<button>");
          $button.addClass("removerow btn btn-danger btn-xs").css("float", "right");
          $button.append($("<span>").addClass("glyphicon glyphicon-remove"));
          $button.click(function(e) {
              $button.parent("li").remove();
              e.preventDefault(); return false;  
          });
          return $button;
        };
        $("ul#relations > li").prepend(getButtonObj());

        $('#addrow').click(function(e) {
          var currentCount = $("#relations li").length;
          $.get('{{ url_for('.articlerelation_form_new', world=world.slug, article=article.slug) }}', function(data) {
            var $d = $(data);
            var prefix = "relations-"+currentCount+"-";
            $d.first("label").html("Relations-"+currentCount);
            $d.find("*[id]").attr("id", prefix+$el.attr("id"));
            $d.find("*[for]").attr("for", prefix+$el.attr("for"));
            $d.find("*[name]").attr("name", prefix+$el.attr("name"));
            
            $("#relations").append($("<li>").append(getButtonObj()).append($d));
          });
          e.preventDefault(); return false;  
        });
        // Editable-list END
        {% endif %}

        //----------------------------------
				// Get the initial value
				var $el = $('.m_action2');
				$el.data('oldVal', '#' + $el.find('option:selected').text()
						+ 'article_form');

				$el.change(function() {
					//store new value
					var $this = $(this);
					var newValue = '#' + $this.find('option:selected').text()
							+ 'article_form'
					$(newValue).toggleClass('hide')
					$($this.data('oldVal')).toggleClass('hide')
					$this.data('oldVal', newValue)
				})

        /*        
        var latlng = [parseFloat($('#placearticle-coordinate_x').val()), parseFloat($('#placearticle-coordinate_y').val())]

        var map = L.map('map', {
          center: [-77, 660],
          zoom: 1,
          minZoom: 0,
          maxZoom: 1
        });
        L.tileLayer('//googledrive.com/host/0Bybs2FIAp3ZTUFd5RHgwS0FCU3M/map/mundana_stor_karta_{z}_{x}_{y}.png', {
          attribution: 'Map data &copy; Neogames',
        minZoom: 0,
        maxZoom: 1,
        noWrap: true,
        continuousWorld: true,
        }).addTo(map);

        var marker
        if (!isNaN(latlng[0]) && !isNaN(latlng[1])) {
          marker = L.marker(latlng).addTo(map);
          map.panTo(latlng);
        }

        function onMapClick(e) {
          $('#placearticle-coordinate_x').val(e.latlng.lat);
          $('#placearticle-coordinate_y').val(e.latlng.lng);
          if(!marker) {
            marker = L.marker(e.latlng).addTo(map);
          } else {
            marker.setLatLng(e.latlng);
          }
        }

        map.on('click', onMapClick);
        */

			});
</script>
{% endif %}
{% endblock %}