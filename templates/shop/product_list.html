{% extends "shop/_page.html" if not parent_template else parent_template %}

{% set currencies = {
  'eur' : 'â‚¬ %s',
  'sek' : '%s :-'
}%}

{% block sidebar %}{{super()}}
  <ul class="nav nav-list">
  <li class="nav-header">{{ _('Actions') }}</li>

  {% if not product %}
  {% call(privileged) MACRO.AUTHORIZED(access_policy['product'].authorize('new')) %}
  <li class="{{privileged}}"><a href="{{ url_for('.product_form_new') }}"><span class="glyphicon glyphicon-pencil"></span> {{ _('New') }}</a></li>
  {% endcall %}
  {% endif %}
{% endblock %}

{% block content %}

    <div class="row">

    {% for product in products %}
    <div class="col-md-4 product">
        {% if product.feature_image %}<a href="{{ url_for('.product_view', product=product.slug)}}"><img class="product-image" src="{{url_for('asset_thumb', slug=product.feature_image.slug)}}"></a>{% endif %}
        <div class="product-intro">
            <h3><a href="{{ url_for('.product_view', product=product.slug)}}">{{ product.title }}</a></h3>
            <p>{{ product.description }}</p>
        </div>
        <ul class="product-details">
            <li class="product-type">{{ product.publisher }}</li>
            <li class="product-price">{{ currencies[product.currency] % product.price|currency }}</li>
            <li><a id="{{product.slug}}" class="btn btn-sm btn-primary buy-link" href="{{ url_for('.order_cart')}}">{{ _('Buy') }}</a></li>
        </ul>
    </div>
    {% if loop.index is divisibleby 3 %}</div><div class="row">{% endif %}
    {% endfor %} 
  </div>
  {% include "includes/pagination.html" %}
{% endblock %}

{% block final %}
{{super() }}
<script>
$('.buy-link').click(function(e) {
    var csrftoken = "{{ csrf_token() }}";
    var jqxhr = $.ajax({
        url: "{{ url_for('.order_cart', out='json')}}",
        type: 'post',
        data: {product: this.id},
        headers: { 'X-CSRFToken': csrftoken },
        dataType: 'json',
        success: function (data) {
            $c = $('#cart-counter')
            $c.html(data.item)
    }})
    .fail(function(jqXHR) {
        var res = JSON.parse(jqXHR.responseText)
        flash_error(res.message, 'danger')
    });
    e.preventDefault();
});
</script>
{% endblock %}