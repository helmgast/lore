{% extends "base.html" %}

{% from 'includes/components.html' import FORM_FIELD, FORM_FIELD_INLINE %}

{% block jsimports %}

  <script type="text/javascript" async 
    src="https://plus.google.com/js/client:plusone.js?onload=start"></script>
  {{super()}}

{#}  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js">
  </script>
  
  <script type="text/javascript">
    (function () {
      var po = document.createElement('script');
      po.type = 'text/javascript';
      po.async = true;
      po.src = 'https://plus.google.com/js/client:plusone.js?onload=start';
      var s = document.getElementsByTagName('script')[0];
      s.parentNode.insertBefore(po, s);
    })();
  </script>
  #}
{% endblock %}

{% if op=='join' %}
  {% set title = _('Sign up') %}
  {% set submit = _('Join') %}
  {% set action = url_for('auth.join') %}
  {% set option_args = {'disabled': True} %}
{% elif op=='login' %}
  {% set title = _('Please sign in') %}
  {% set submit = _('Sign in') %}
  {% set action = '' %}
  {% set option_args = {'disabled': True} %}
{% elif op=='verify' %}
  {% set title = _('Complete your account') %}
  {% set submit = _('Join') %}
  {% set action = url_for('auth.join') %}
  {% set option_args = {} %}
{% endif %}
{% block pre_content %}{% endblock %}
{% block content %}
<form id="auth-form" method="post" action="" class="col-sm-6 col-sm-offset-3" role="form">
  {% include "includes/flash.html" %}
  <h2 class="form-signin-heading">{{ title }}</h2>
  <input type="hidden" name="next" value="{{ next }}" />
  <div id="external-auth">
    <span class="help-block">{{submit}} {{_('with external provider (safer!)')}}</span>
    <div id="signinButton">
      <span class="g-signin"
        data-scope="https://www.googleapis.com/auth/plus.login https://www.googleapis.com/auth/plus.profile.emails.read"
        data-clientid="852791556464-vbn49e0lkc9tvpferm4otdtbpjbk11r1.apps.googleusercontent.com"
        data-width="wide"
        data-height="tall"
        data-redirecturi="postmessage"
        data-accesstype="offline"
        data-cookiepolicy="single_host_origin"
        data-callback="googleCallback">
      </span>
    </div>
  {#  <button class="btn btn-lg btn-primary btn-block" type="button">Facebook</button> #}
  </div>
  <hr>
  <div id="profile"></div>

  <span class="help-block">{{submit}} {{_('with Fablr account')}}</span>
  {{ FORM_FIELD_INLINE(form.email, controlclass="input-lg", required=True, autofocus=True) }}
  {{ FORM_FIELD_INLINE(form.password, controlclass="input-lg", required=True) if form.password }}
  {{ FORM_FIELD_INLINE(form.confirm_password, controlclass="input-lg") if form.confirm_passwor }}
  {% if op!='login' %}
  <div id="optional-inputs" class="well">
    <span class="help-block">{{_('Optional details')}}</span>
    {{ FORM_FIELD_INLINE(form.username, controlclass="input-lg", **option_args)}}
    {{ FORM_FIELD_INLINE(form.realname, controlclass="input-lg", **option_args)}}
    {{ FORM_FIELD_INLINE(form.location, controlclass="input-lg", **option_args)}}
    <div class="checkbox">
    <label>
      {{form.newsletter(disabled=True)}}
      Receive newsletter
    </label>
    </div>
  </div>
  {% endif %}
  {{ form.email_token if form.email_token }}
  {{ form.external_service }}
  {{ form.external_id }}
  {{ form.auth_code }}
  {{ form.csrf_token }}

  <button class="btn btn-lg btn-success btn-block" type="submit">{{ submit }}</button>
</form>
{% endblock %}

{% block final %}
{{super()}}
<script>
function googleCallback(authResult) {  
  if (authResult['code']) {
    $('#external-auth').hide()

    gapi.client.load('plus','v1', function(){
      var request = gapi.client.plus.people.get( {'userId' : 'me'} );
      request.execute( function(profile) {
        $('#profile').empty();
        if (profile.error) {
          $('#profile').append(profile.error);
          return;
        }
        $('#auth_code').val(authResult['code'])
        $('#external_service').val('google')
        $('#realname').val(profile.displayName)
        $('#email').val(profile.emails.length && profile.emails[0].value).focus()
        $('#location').val(profile.placesLived.length && profile.placesLived[0].value)
        $('#password').attr('disabled', true).hide()
        $('#confirm_password').attr('disabled', true).hide()
        $('#optional-inputs input').attr('disabled', false)
        $('#profile').append(
            $('<p><img src=\"' + profile.image.url + '\"></p>'));
        $('#profile').append(
            $('<p>Hello ' + profile.displayName + '!</p>'));
        if (profile.cover && profile.coverPhoto) {
          $('#profile').append(
              $('<p><img src=\"' + profile.cover.coverPhoto.url + '\"></p>'));
        }
        // var signout = $('<button class="btn" type="button">Sign out from Google</button>')
        //   .click(function(e) {
        //     gapi.auth.signOut();
        //   })
        // $('#profile').append(signout)
      });
    });
  } else {
    var error = authResult['error'] || "Network problem"
    console.log(error)
    // if (error!='immediate_failed') { // couldn't auto-signin
    //   alert('Error: '+error)      
    // }
  }
  
}
</script>
{% endblock %}