{% if not inline %}{% extends "social/social.html" %}
{% else %}{% extends "includes/inline.html" %}{% endif %}

{% block content_title %}Conversation with {{ recipients|join(', ')|truncate(20) }}{% endblock %}

{% block content_tagline %}{% endblock %}

{% if conversation %}
  {% set action_url = url_for('social.conversation_detail', conv_id=conversation.id, inline=inline) %}
  {% set fixed_recipients = True %} {# fixed recipients always when having exiting conversation #}
{% else %}
  {% set action_url = url_for('social.conversation_new', inline=inline) %}
{% endif %}

{% block content %}{% block inline %}

<form class="modal-form" action="{{ action_url }}" method="post">
{# note, Jinja seem to autoescape class names, so no need for "" #}
  <div{{ ' class=modal-body' if inline }}>
  {% if conversation %}
    {% include "includes/pagination.html" %}
    <ul class="unstyled">
      {% set is_conversation = True %}
      {% for message in message_list|reverse %}
        <li>{% include "includes/message.html" %}</li>
      {% endfor %}
    </ul>
  {% endif %}  
  </div>
  <div{{ ' class=modal-footer' if inline }}>
    <textarea class="message" rows="4" name="content" autofocus></textarea>
    <select name="recipients" multiple="multiple"{{ ' class=hide' if fixed_recipients }}>
      {% for r in recipients %}
      <option selected="selected">{{ r }}</option>
      {% endfor %}
    </select>
    <button type="submit" class="btn btn-primary">Send</button>
  </div>
</form>
{% endblock %}{% endblock %}
{% block final %}
  {{super() }}
  <script>
  // Scrolls the modal inner frame to bottom to show latest message
  $(document).on('shown', '#themodal', function(e) {
    var $m = $('.modal-body');
    console.log($m);
    $m.animate({scrollTop: $m.prop('scrollHeight') - $m.height()}, 500)
  })
</script>
{% endblock %}