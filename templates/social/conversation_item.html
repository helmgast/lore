{% extends "social/base.html" if not parent_template else parent_template %}

{% set recipients = conversation.members %}

{% block content_title %}{{'New conversation' if op=='new' else 'Conversation'}} with {{ recipients|join(', ')|truncate(20) }}{% endblock %}  

{% block content_tagline %}{% endblock %}

{% if conversation %}
  {% set fixed_recipients = True %} {# fixed recipients always when having existing conversation #}
{% endif %}

{% block content %}{% block inline %}
<div class="row">
  <div class="col-md-8">
  {% if conversation %}
    <ul class="list-unstyled">
      {% set is_conversation = True %}
      {% for message in conversation.messages() %}
        <li>{% include "social/message_item.html" %}</li>
      {% endfor %}
    </ul>
  {% endif %}  
  <form action="{{ url_for('.message_new', conversation=conversation.id, next=url_for('.conversation_view', conversation=conversation.id)) }}" method="post">
    {% if conversation_form %}
    <p>Members: {{conversation_form['members'](**{'data-role':'chosen','style':'width:100%;'}) }}</p>
    {% endif %}
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
    <input type="hidden" name="user" value="{{g.user.id}}" />
    <input type="hidden" name="conversation" value="{{conversation.id}}" />    
    {#<select name="recipients" multiple="multiple"{{ ' class=hide' if fixed_recipients }}>
      {% for r in recipients %}
      <option selected="selected">{{ r }}</option>
      {% endfor %}
    </select>
    #}
    <textarea class="form-control" rows="4" name="content" autofocus></textarea>
    <button type="submit" class="btn btn-primary btn-block">Send</button>
  </form>
  </div>
</div>
{% endblock %}{% endblock %}
{% block final %}
  {{super() }}
  <script>
  // Scrolls the modal inner frame to bottom to show latest message
  $(document).on('shown', '#themodal', function(e) {
    var $m = $('.modal-body');
    console.log($m);
    $m.animate({scrollTop: $m.prop('scrollHeight') - $m.height()}, 500)
  })
</script>
{% endblock %}