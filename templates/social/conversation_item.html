{% extends "social/base.html" if not parent_template else parent_template %}

{% set recipients = conversation.members if conversation else [] %}

{% block content_title %}{% if op=='new' %}New conversation{% elif conversation.title %}{{conversation.title}}{% else %}Conversation{%endif%}{% endblock %} 

{% block content_tagline %}{% endblock %}
{% block content_subheader %}<span class="nav-header">Members:</span> {{ recipients|join(', ')|truncate(20) }}{%endblock%}

{% if conversation %}
  {% set fixed_recipients = True %} {# fixed recipients always when having existing conversation #}
{% endif %}

{% block content %}{% block inline %}
<div class="row">
  <div class="col-md-8">
  {% if conversation %}
    <ul class="list-unstyled">
      {% set is_conversation = True %}
      {% for message in conversation.messages() %}
        <li>{% include "social/message_item.html" %}</li>
      {% endfor %}
    </ul>
  {% endif %}  
  {% if conversation_form %}
  <form action="{{conversation_form.action_url}}" method="post">
    <p>Title: {{conversation_form.title(style='width:100%;') }}</p>
    <p>Members: {{conversation_form.members(**{'data-role':'chosen', 'data-placeholder':"Recipients...", 'style':'width:100%;'}) }}</p>
    {{conversation_form.csrf_token()}}
    <textarea class="form-control" rows="4" name="content" autofocus></textarea>
    <button type="submit" class="btn btn-primary btn-block">Send</button>
  </form>
  {% endif %}
  </div>
</div>
{% endblock %}{% endblock %}
{% block final %}
  {{super() }}
  <script>
  // Scrolls the modal inner frame to bottom to show latest message
  $(document).on('shown', '#themodal', function(e) {
    var $m = $('.modal-body');
    console.log($m);
    $m.animate({scrollTop: $m.prop('scrollHeight') - $m.height()}, 500)
  })
</script>
{% endblock %}