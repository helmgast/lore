{# 
Order confirmation email.
Should be sent when an ordered is created (checkout) and when
an ordered is changed for any reason. If the order is changed, make sure to 
highlight what is changing, e.g. status or address.

Should be sent to lekbergs as well, e.g. a copy?

Data:

user
order (receipt)

Also has a variant for crowdfunding.
#}

{% extends "mail/one_column_mail.html" %}

{% set prod_types = {
  'book':_('Book'),
  'item':_('Item'),
  'digital':_('Digital'),
  'shipping':_('Shipping fee')}
  %}

{% set currencies = {
  'eur' : 'â‚¬ %s',
  'sek' : '%s :-'
}%}

{% set order_statuses = {
  'cart' : _('Cart'),
  'ordered' : _('Ordered'),
  'paid' : _('Paid'),
  'shipped' : _('Shipped'),
  'error' : _('Error')}
%}

{% block subject %}Thank you for your order!{% endblock %}

{% block preview %}Order confirmation on helmgast.se{% endblock %}

{% block content %}


<p>Thank you {{user.display_name() if user}} for your order at helmgast.se! Please see your receipt below:</p>

<table>
<!-- Order info-->
<tr>
	<!-- Order/customer info-->
	<td>
	<h2>{{_('Order Info')}}</h2>
  	<table class="table table-condensed">
	    <tr><th>{{_('Name')}}</th><td>{{order.user.realname|hidenone(_('No name'))}}</td></tr>
	    <tr><th>{{_('Email')}}</th><td>{{order.user.email}}</td></tr>
	    <tr><th>{{_('Created')}}</th><td>{{order.created.strftime('%Y-%m-%d %H:%M')}}</td></tr>
	    <tr><th>{{_('Updated')}}</th><td>{{order.updated.strftime('%Y-%m-%d %H:%M')}}</td></tr>
	    <tr><th>{{_('Status')}}</th><td>{{order_statuses[order.status]}}</td></tr>
  	</table>
	</td>
</tr>
<tr>
	<!-- Seller info-->
	<td>
	<h2>{{_('Seller Info')}}</h2>
    <table class="table table-condensed">
	    <tr><th>{{_('Publisher')}}</th><td>Helmgast AB</td></tr>
	    <tr><th>{{_('Email')}}</th><td><a href="mailto:info@helmgast.se">info@helmgast.se</a></td></tr>
	    <tr><th>{{_('Address')}}</th><td>
	    Surbrunnsgatan 33<br>
	    Stockholm 113 48<br>
	    </td></tr>
	</table>
	</td>
</tr>
<!-- Items -->
<tr>
	<td>
	<table>
		<tr><th colspan=2>{{_('Product')}}</th><th style="text-align:left">{{_('Quantity')}}</th><th style="text-align:left">{{_('Price')}}</th><th style="text-align:left">{{_('Total')}}</th></tr>
    	{% for line in order.order_lines %}
    	{% if line.product.status != 'hidden' %}
    	<tr>
    		<td>{% if line.product.feature_image %}<a href="{{ url_for('shop.product_view', product=line.product.slug)}}"><img class="product-image" src="{{url_for('asset_thumb', slug=line.product.feature_image.slug)}}"></a>{% endif %}</td>
    		<td>
    			<h3><a href="{{ url_for('shop.product_view', product=line.product.slug)}}">{{ line.product.title }}</a> <small>{{line.product.publisher}}</small></h3>
	            <p>{{ line.product.description }}</p>
	            {% if order_form %}
	            {{ order_form.order_lines[loop.index0].product(class="hide")}}
	            {% endif %}
	            {% if line.product.status == 'ready_for_download' and line.product.type == 'digital' %}
	            {% if line.product.resources %}
	              {% for resource in line.product.resources %}
	                <h4><a href="{{ url_for('shop.download_pdf', product=line.product.slug, resource=resource)}}"><span class="glyphicon glyphicon-download"></span> {{_('Download')}} {{resource}}</a>
	                </h4>
	              {% endfor %}
	            {% else %}
	              <h4><a href="{{ url_for('shop.download_pdf', product=line.product.slug)}}"><span class="glyphicon glyphicon-download"></span> {{_('Download')}}</a>
	              </h4>
	            {% endif %}
	            {% endif%}
    		</td>
    		<td>
    			{% if order_form and order.status=='cart' %}
                	{{order_form.order_lines[loop.index0].quantity(type="number", min="1", max="100", style="width: 40px", class="product-quantity")}}
              	{% else %}
                	{{ line.quantity }}
              	{% endif %}
    		</td>
    		<td>{{ currencies[line.product.currency] % line.product.price|currency if order.status=='cart' else currencies[line.product.currency] % line.price|currency }}</td>
    		<td>{{ currencies[line.product.currency] % (line.quantity*line.price)|currency}}</td>
    	</tr>
    	{% endif %}
    	{% endfor %}
    	<tr>
    		<td colspan=4 style="text-align:right">{{_('Including tax')}}</td><td>{{ currencies.get(order.currency,'%s') % ((1-1/1.06)*order.total_price)|currency}}</td>
    	</tr>
    	<tr>
    		<td colspan=4 style="text-align:right">{{_('Grand Total')}}</td><td>{{ currencies.get(order.currency,'%s') % order.total_price|currency}}</td>
    	</tr>
	</table>
	</td>
</tr>
<!-- Address -->
<tr>
	<td>
	<h4>{{_('Shipping Address')}}<small style="margin-left: 20px">{{_("make sure it's correct!")}}</small></h4>
	<table>
		<tr>
          <td colspan=2><strong>{{_('Name')}}</strong></td>
          <td colspan=2>{{order.shipping_address.name|default('test')}}</td>
        </tr>
        <tr>
          <td colspan=2><strong>{{_('Street')}}</strong></td>
          <td colspan=2>{{order.shipping_address.street}}</td>
        </tr>
        <tr>
          <td><strong>{{_('ZIP Code')}}</strong></td>
          <td>{{order.shipping_address.zipcode}}</td>
          <td><strong>{{_('City')}}</strong></td>
          <td>{{order.shipping_address.city}}</td>
        </tr>
        <tr>
          <td colspan=2><strong>{{_('Country')}}</strong></td>
          <td colspan=2>{{order.shipping_address.country}}</td>
        </tr>
         <tr>
          <td colspan=2><strong>{{_('SMS Number')}}</strong></td>
          <td colspan=2>{{order.shipping_address.mobile}}</td>
        </tr>
	</table>
	</td>
</tr>
</table>

<p><em>You received this email as a confirmation of your purchase order at helmgast.se.
Please read the terms and conditions of purchase here.</em></p>
{% endblock %}